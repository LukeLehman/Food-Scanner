<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Food Scanner">
    <meta name="theme-color" content="#001f3f">
    <meta name="description" content="Scan and analyze your food nutritional information">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23001f3f' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>üçΩÔ∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23001f3f' width='180' height='180' rx='40'/><text x='50%' y='50%' font-size='90' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>üçΩÔ∏è</text></svg>">
    <title>Food Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
            min-height: 100vh;
            min-height: 100svh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            padding: max(20px, env(safe-area-inset-bottom));
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .content {
            padding: 30px 20px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .camera-section {
            margin-bottom: 30px;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            -webkit-user-select: none;
            user-select: none;
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        #canvas {
            display: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-appearance: none;
            appearance: none;
            -webkit-user-select: none;
            user-select: none;
            min-height: 44px;
            -webkit-flex-grow: 0;
            flex-grow: 0;
        }

        button:active:not(:disabled) {
            opacity: 0.9;
        }

        .btn-primary {
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 31, 63, 0.4);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e8e8e8;
            border-color: #d0d0d0;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        .gallery-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .gallery-section h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
            -webkit-user-select: none;
            user-select: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .gallery-item {
            position: relative;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .gallery-item:active {
            transform: scale(0.95);
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
            padding: 0;
            min-height: auto;
            -webkit-user-select: none;
            user-select: none;
        }

        .gallery-item:active .delete-btn,
        .gallery-item:hover .delete-btn {
            opacity: 1;
        }

        .empty-gallery {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 8px;
            -webkit-user-select: none;
            user-select: none;
        }

        .camera-status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .camera-select {
            margin-bottom: 15px;
        }

        .camera-select label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            -webkit-user-select: none;
            user-select: none;
        }

        .camera-select select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: border-color 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1.5em;
            padding-right: 2.5rem;
            -webkit-user-select: none;
            user-select: none;
        }

        .camera-select select:focus {
            outline: none;
            border-color: #001f3f;
        }

        @media (max-width: 600px) {
            .controls {
                grid-template-columns: 1fr;
            }

            .btn-primary {
                grid-column: 1;
            }

            .header h1 {
                font-size: 24px;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .content {
                padding: 20px;
            }

            body {
                padding: 0;
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }

            .container {
                border-radius: 20px 20px 0 0;
                max-width: 100%;
            }

            .header {
                border-radius: 20px 20px 0 0;
            }
        }

        @supports (padding: max(0px)) {
            body {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                padding-top: max(20px, env(safe-area-inset-top));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }

        .photo-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            text-align: center;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .no-photo-text {
            color: #999;
            font-size: 14px;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Food Scanner</h1>
            <p>Scan and analyze your food</p>
        </div>

        <div class="content">
            <div class="camera-section">
                <div id="statusMessage" class="camera-status"></div>

                <div class="camera-select">
                    <label for="cameraSelect">Select Camera:</label>
                    <select id="cameraSelect">
                        <option value="">Loading cameras...</option>
                    </select>
                </div>

                <div id="iosHint" style="display: none; font-size: 12px; color: #666; margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    üí° On first use, tap "Scan Food" and allow camera access in the permission popup.
                </div>

                <div id="videoContainer">
                    <video id="video" autoplay playsinline muted webkit-playsinline></video>
                </div>

                <div class="controls">
                    <button class="btn-primary" id="captureBtn">Scan Food</button>
                    <button class="btn-secondary" id="retakeBtn" disabled>Retake</button>
                </div>
            </div>

            <div class="gallery-section">
                <h2>Current Scan</h2>
                <div class="photo-preview" id="photoPreview">
                    <p class="no-photo-text">No scan captured yet. Tap 'Scan Food' to begin.</p>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }

        // Prevent zoom on iPhone
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            let now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;

        // Camera Application
        class CameraApp {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.captureBtn = document.getElementById('captureBtn');
                this.retakeBtn = document.getElementById('retakeBtn');
                this.photoPreview = document.getElementById('photoPreview');
                this.statusMessage = document.getElementById('statusMessage');
                this.cameraSelect = document.getElementById('cameraSelect');
                this.iosHint = document.getElementById('iosHint');
                
                this.stream = null;
                this.devices = [];
                this.currentPhoto = null;
                this.isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                this.permissionGranted = false;
                
                // Show iOS hint if on iOS
                if (this.isIOS && this.iosHint) {
                    this.iosHint.style.display = 'block';
                }
                
                this.initializeEventListeners();
                this.loadPhotoFromStorage();
                this.checkBrowserSupport();
                
                // Auto-load cameras on non-iOS devices
                if (!this.isIOS) {
                    this.loadAvailableCameras();
                } else {
                    this.cameraSelect.innerHTML = '<option value="">Tap "Scan Food" to initialize...</option>';
                }
            }

            checkBrowserSupport() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showStatus('Your browser does not support camera access. Please use Chrome, Firefox, Safari, or Edge.', 'error');
                    this.startBtn.disabled = true;
                    return false;
                }
                return true;
            }

            initializeEventListeners() {
                this.captureBtn.addEventListener('click', async () => {
                    if (!this.stream) {
                        // Auto-start camera when capture is clicked
                        await this.startCamera();
                    } else {
                        // Camera already running, capture the photo
                        this.capturePhoto();
                    }
                });
                this.retakeBtn.addEventListener('click', () => this.retakePhoto());
                this.cameraSelect.addEventListener('change', () => this.switchCamera());

                // Add touchstart event for iOS button feedback
                [this.captureBtn, this.retakeBtn].forEach(btn => {
                    btn.addEventListener('touchstart', function() {
                        this.style.opacity = '0.7';
                    });
                    btn.addEventListener('touchend', function() {
                        this.style.opacity = '1';
                    });
                });
            }

            async loadAvailableCameras() {
                try {
                    // On iOS, sometimes we need to wait a bit for devices to appear
                    let retries = 0;
                    let devices = [];
                    
                    while (devices.length === 0 && retries < 3) {
                        devices = await navigator.mediaDevices.enumerateDevices();
                        devices = devices.filter(device => device.kind === 'videoinput');
                        
                        if (devices.length === 0 && this.isIOS && retries < 2) {
                            // Wait a bit before retrying on iOS
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        } else {
                            break;
                        }
                    }
                    
                    this.devices = devices;
                    this.cameraSelect.innerHTML = '';
                    
                    if (this.devices.length === 0) {
                        this.cameraSelect.innerHTML = '<option value="">Default Camera</option>';
                        return;
                    }

                    this.devices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `Camera ${index + 1}`;
                        this.cameraSelect.appendChild(option);
                    });

                    if (this.devices.length > 0) {
                        this.cameraSelect.value = this.devices[0].deviceId;
                    }
                    
                    console.log(`Found ${this.devices.length} camera(s)`);
                } catch (error) {
                    console.error('Error loading cameras:', error);
                    this.cameraSelect.innerHTML = '<option value="">Default Camera</option>';
                }
            }

            async startCamera() {
                try {
                    // Check HTTPS requirement (relaxed for iOS web apps)
                    const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    
                    if (!isSecure && !this.isIOS && !this.isSafari) {
                        this.showStatus('Camera access requires HTTPS. Please serve this file over HTTPS or localhost.', 'error');
                        return;
                    }

                    let stream = null;

                    // iOS Safari: Use extremely simple constraints first
                    if (this.isIOS) {
                        try {
                            // First attempt: just request video, no constraints
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: true,
                                audio: false 
                            });
                            
                            // Success! Now we can load cameras
                            this.permissionGranted = true;
                            
                            // Load cameras now that permission is granted
                            if (this.devices.length === 0) {
                                await this.loadAvailableCameras();
                            }
                        } catch (firstError) {
                            console.error('iOS first attempt failed:', firstError);
                            
                            // Try with facing mode
                            try {
                                stream = await navigator.mediaDevices.getUserMedia({ 
                                    video: { facingMode: 'environment' },
                                    audio: false 
                                });
                                this.permissionGranted = true;
                                if (this.devices.length === 0) {
                                    await this.loadAvailableCameras();
                                }
                            } catch (secondError) {
                                throw secondError;
                            }
                        }
                    } else {
                        // Desktop/Android: Use optimized constraints
                        const constraints = {
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                facingMode: 'environment'
                            },
                            audio: false
                        };

                        // Add deviceId if available and selected
                        const deviceId = this.cameraSelect.value;
                        if (deviceId) {
                            constraints.video.deviceId = { exact: deviceId };
                        }

                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        this.permissionGranted = true;
                    }

                    this.stream = stream;
                    this.video.srcObject = stream;
                    
                    // Ensure video plays
                    await this.video.play().catch(error => {
                        console.error('Play error:', error);
                    });
                    
                    this.captureBtn.disabled = false;
                    this.retakeBtn.disabled = true;
                    this.cameraSelect.disabled = true;
                    
                    this.showStatus('‚úì Camera ready to scan', 'success');
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    let errorMsg = 'Error accessing camera';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMsg = 'Camera permission denied. Please allow camera access in Settings > Safari and try again.';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg = 'No camera found on this device';
                    } else if (error.name === 'NotReadableError') {
                        errorMsg = 'Camera is already in use by another app';
                    } else if (error.name === 'SecurityError') {
                        errorMsg = 'Camera access is not allowed. Make sure you\'re using HTTPS.';
                    } else if (error.name === 'TypeError') {
                        errorMsg = 'Camera constraints not supported';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMsg = 'Camera cannot meet the requested constraints';
                    }
                    
                    this.showStatus('‚úó ' + errorMsg, 'error');
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.video.srcObject = null;
            }

            capturePhoto() {
                if (!this.stream) {
                    this.showStatus('Camera not started', 'error');
                    return;
                }

                try {
                    const context = this.canvas.getContext('2d');
                    
                    // Ensure video dimensions are available
                    if (this.video.videoWidth === 0 || this.video.videoHeight === 0) {
                        this.showStatus('Video stream not ready. Wait a moment and try again.', 'error');
                        return;
                    }
                    
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;
                    
                    context.drawImage(this.video, 0, 0);
                    const photoData = this.canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Save only one photo
                    this.currentPhoto = {
                        data: photoData,
                        timestamp: new Date().toLocaleString()
                    };

                    this.savePhotoToStorage();
                    this.displayPhoto();
                    this.captureBtn.disabled = true;
                    this.retakeBtn.disabled = false;
                    this.showStatus('Food scanned successfully! Tap Retake to scan again.', 'success');
                } catch (error) {
                    console.error('Error capturing photo:', error);
                    this.showStatus('Error capturing photo: ' + error.message, 'error');
                }
            }

            retakePhoto() {
                this.currentPhoto = null;
                this.savePhotoToStorage();
                this.displayPhoto();
                this.captureBtn.disabled = false;
                this.retakeBtn.disabled = true;
                this.showStatus('Ready to scan again', 'success');
            }

            displayPhoto() {
                if (!this.currentPhoto) {
                    this.photoPreview.innerHTML = '<p class="no-photo-text">No scan captured yet. Tap \'Scan Food\' to begin.</p>';
                    return;
                }

                this.photoPreview.innerHTML = `
                    <img src="${this.currentPhoto.data}" alt="Scanned food">
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">${this.currentPhoto.timestamp}</p>
                `;
            }

            savePhotoToStorage() {
                try {
                    if (this.currentPhoto) {
                        localStorage.setItem('foodScanPhoto', JSON.stringify(this.currentPhoto));
                    } else {
                        localStorage.removeItem('foodScanPhoto');
                    }
                } catch (error) {
                    console.error('Error saving photo:', error);
                    if (error.name === 'QuotaExceededError') {
                        this.showStatus('Storage quota exceeded', 'error');
                    }
                }
            }

            loadPhotoFromStorage() {
                try {
                    const stored = localStorage.getItem('foodScanPhoto');
                    if (stored) {
                        this.currentPhoto = JSON.parse(stored);
                        this.displayPhoto();
                        this.captureBtn.disabled = true;
                        this.retakeBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error loading photo:', error);
                }
            }

            showStatus(message, type) {
                this.statusMessage.textContent = message;
                this.statusMessage.className = `camera-status status-${type}`;
                
                setTimeout(() => {
                    this.statusMessage.className = 'camera-status';
                }, 3000);
            }

            async switchCamera() {
                if (this.stream) {
                    this.stopCamera();
                    setTimeout(() => this.startCamera(), 500);
                }
            }
        }

        // Initialize the app
        const cameraApp = new CameraApp();
    </script>
</body>
</html>
